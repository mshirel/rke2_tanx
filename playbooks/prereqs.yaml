---
- name: Kubernetes / RKE2 prerequisites on Ubuntu
  hosts: rke2_cluster
  serial: 1
  become: true
  gather_facts: true

  vars:
    # K8s networking modules
    k8s_kernel_modules:
      - overlay
      - br_netfilter

    # K8s sysctl tuning (baseline)
    k8s_sysctls:
      - { name: "net.bridge.bridge-nf-call-iptables",  value: 1 }
      - { name: "net.bridge.bridge-nf-call-ip6tables", value: 1 }
      - { name: "net.ipv4.ip_forward",                 value: 1 }

    # Baseline packages that commonly help with ops/debugging
    base_packages:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - apt-transport-https
      - jq
      - socat
      - conntrack
      - ipset
      - iptables
      - ethtool
      - chrony

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
  
    - name: Perform full system upgrade (dist-upgrade)
      ansible.builtin.apt:
        upgrade: dist
        autoremove: true
        autoclean: true
  
    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Reboot node if required
      ansible.builtin.reboot:
        reboot_timeout: 900
        connect_timeout: 5
        pre_reboot_delay: 10
        post_reboot_delay: 30
        test_command: whoami
      when: reboot_required.stat.exists

    - name: Install base packages
      ansible.builtin.apt:
        name: "{{ base_packages }}"
        state: present

    # Timezone (optional: uses group_vars/all.yaml if you set timezone there)
    - name: Set timezone if timezone var is defined
      community.general.timezone:
        name: "{{ timezone }}"
      when: timezone is defined

    - name: Ensure chrony is enabled and running
      ansible.builtin.service:
        name: chrony
        state: started
        enabled: true

    # --- Swap must be off for Kubernetes ---
    - name: Disable swap immediately (swapoff -a)
      ansible.builtin.command: swapoff -a
      changed_when: false

    - name: Comment out swap entries in /etc/fstab (persist across reboot)
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^(\s*[^#\n]+\s+[^#\n]+\s+swap\s+[^#\n]+\s+[^#\n]+\s+[^#\n]+)$'
        replace: '# \1'
      register: fstab_swap

    - name: Warn if swap entries were found and commented
      ansible.builtin.debug:
        msg: "Swap entries were found in /etc/fstab and commented out."
      when: fstab_swap is changed

    # --- Kernel modules for container networking ---
    - name: Ensure kernel modules config file exists
      ansible.builtin.copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          {% for m in k8s_kernel_modules %}
          {{ m }}
          {% endfor %}
        owner: root
        group: root
        mode: "0644"

    - name: Load required kernel modules now
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop: "{{ k8s_kernel_modules }}"

    # --- Sysctl settings required by kube networking ---
    - name: Write sysctl settings for Kubernetes
      ansible.builtin.copy:
        dest: /etc/sysctl.d/99-k8s.conf
        content: |
          {% for s in k8s_sysctls %}
          {{ s.name }} = {{ s.value }}
          {% endfor %}
        owner: root
        group: root
        mode: "0644"

    - name: Apply sysctl settings
      ansible.builtin.command: sysctl --system
      changed_when: false

    # --- Sanity checks (fail fast) ---
    - name: Check swap is disabled
      ansible.builtin.command: /bin/sh -c "swapon --summary | wc -l"
      register: swap_lines
      changed_when: false

    - name: Fail if swap is still enabled
      ansible.builtin.fail:
        msg: "Swap is still enabled on this node. Kubernetes requires swap to be disabled."
      when: (swap_lines.stdout | int) > 0
