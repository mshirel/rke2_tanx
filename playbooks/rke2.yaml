---
# RKE2 install: servers first, then agents.
# Assumes:
# - inventory groups: rke2_servers and rke2_agents (as you built)
# - group_vars/all.yaml contains shared settings (version, token, etc.)
# - group_vars/rke2_servers.yaml and rke2_agents.yaml define node roles

# --- Pre-flight validation ---
- name: Validate required variables
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Abort if rke2_token is not set
      ansible.builtin.fail:
        msg: >
          rke2_token is not set.
          RKE2_TOKEN environment variable is not set.
          Ensure ~/.secrets is sourced (e.g., from ~/.profile) before running.
      when: (lookup('ansible.builtin.env', 'RKE2_TOKEN') | length) < 20

- name: Deploy RKE2 (servers first, then agents)
  hosts: rke2_cluster
  become: true
  gather_facts: true
  serial: 1

  tasks:
    - name: Install / configure RKE2 via lablabs role
      ansible.builtin.include_role:
        name: lablabs.rke2
