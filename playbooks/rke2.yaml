---
# RKE2 install: servers first, then agents.
# Assumes:
# - inventory groups: rke2_servers and rke2_agents (as you built)
# - group_vars/all.yaml contains shared settings (version, token, etc.)
# - group_vars/rke2_servers.yaml and rke2_agents.yaml define node roles

# --- Pre-flight validation ---
- name: Validate required variables
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Abort if rke2_token is not set
      ansible.builtin.fail:
        msg: >
          rke2_token is not set.
          RKE2_TOKEN environment variable is not set.
          Ensure ~/.secrets is sourced (e.g., from ~/.profile) before running.
      when: (lookup('ansible.builtin.env', 'RKE2_TOKEN') | length) < 20

- name: Deploy RKE2 servers
  hosts: rke2_servers
  become: true
  gather_facts: true
  serial: 1

  pre_tasks:
    - name: Ensure ansible_default_ipv6 has expected keys
      ansible.builtin.set_fact:
        ansible_default_ipv6: >-
          {{
            ansible_default_ipv6 | default({}) |
            combine({'address':'', 'gateway':'', 'interface':''}, recursive=True)
          }}

    - name: Gather service facts (required by lablabs.rke2 active_server detection)
      ansible.builtin.service_facts:

  roles:
    - lablabs.rke2


- name: Deploy RKE2 agents
  hosts: rke2_agents
  become: true
  gather_facts: true
  serial: 2   # or 1 if you want ultra-safe

  pre_tasks:
    - name: Ensure ansible_default_ipv6 has expected keys
      ansible.builtin.set_fact:
        ansible_default_ipv6: >-
          {{
            ansible_default_ipv6 | default({}) |
            combine({'address':'', 'gateway':'', 'interface':''}, recursive=True)
          }}

    - name: Gather service facts (required by lablabs.rke2 active_server detection)
      ansible.builtin.service_facts:

  roles:
    - lablabs.rke2
